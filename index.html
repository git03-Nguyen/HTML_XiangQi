<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./css/main.css">
  <title>Chinese Chess (Xiangqi) - 21120171</title>
</head>

<body>
  <!-- <h1>Nguyễn Đình Ánh - 21120171</h1> -->
  <!-- Chinese chess board -->
  <div class="game-container">
    <div class="chess-board">
      <img class="board-image" src="/img/board/board.png" alt="Board image">
      <div class="pieces-field">
        <div class="row">
          <div class="square">
            <img class="piece black chariot draggable" src="/img/pieces/bR.png" alt="black Rook">
          </div>
          <div class="square">
            <img class="piece black horse draggable" src="/img/pieces/bN.png" alt="black B">
          </div>
          <div class="square">
            <img class="piece" src="/img/pieces/bB.png" alt="black B">
          </div>
          <div class="square">
            <img class="piece" src="/img/pieces/bA.png" alt="black B">
          </div>
          <div class="square">
            <img class="piece" src="/img/pieces/bK.png" alt="black B">
          </div>
          <div class="square">
            <img class="piece" src="/img/pieces/bA.png" alt="black B">
          </div>
          <div class="square">
            <img class="piece" src="/img/pieces/bB.png" alt="black B">
          </div>
          <div class="square">
            <img class="piece" src="/img/pieces/bN.png" alt="black B">
          </div>
          <div class="square">
            <img class="piece" src="/img/pieces/bR.png" alt="black B">
          </div>
        </div>
        <div class="row">
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
        </div>
        <div class="row">
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
        </div>
        <div class="row">
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
        </div>
        <div class="row">
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
        </div>
        <div class="row">
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
        </div>
        <div class="row">
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
        </div>
        <div class="row">
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
        </div>
        <div class="row">
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
        </div>
        <div class="row">
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
        </div>
      </div>
    </div>
  </div>

  <script>

    // Initializer
    let chessBoard = document.querySelector(".game-container .chess-board");
    let allSquares = Array.from(document.querySelectorAll(".game-container .chess-board .pieces-field .row .square"));
    allSquares.forEach((square, index) => {
      square.dataset.x = index % 9;
      square.dataset.y = Math.floor(index / 9);
    });

    let pieceDragged = null; // no piece is being dragged
    let availableMoves = null;
    let oldSquare = null;
    let lastHoverSquare = null;

    document.querySelectorAll(".piece").forEach(piece => {
      piece.addEventListener("mousedown", onMouseDownHandler);
      piece.ondragstart = (event) => event.preventDefault();
      piece.dataset.tableMoves = new Array();
      if (piece.classList.contains("black")) {
        piece.dataset.isBlack = true;
      } else {
        piece.dataset.isBlack = false;
      }
    });

    // First update
    updateMoves();

    // Mouse down handler
    function onMouseDownHandler(event) {
      if (!event.target.classList.contains("piece")) return;
      if (!event.target.classList.contains("draggable")) return;

      pieceDragged = event.target;
      oldSquare = pieceDragged.parentElement;
      console.log("Mouse down");

      chessBoard.insertAdjacentElement("afterBegin", pieceDragged);
      pieceDragged.classList.add("dragging");
      oldSquare.classList.add("highlighted");

      movePieceAtSpace(event.clientX, event.clientY);

      //showMoves(pieceDragged);

      document.addEventListener('mousemove', onMouseMoveHandler);
      document.addEventListener('mouseup', onMouseUpHandler);

      // Mouse move handler
      function onMouseMoveHandler(event) {

        console.log("Mouse move");
        movePieceAtSpace(event.clientX, event.clientY);
        oldSquare.classList.add("highlighted");

        pieceDragged.hidden = true;
        let elemBelow = document.elementFromPoint(event.clientX, event.clientY)?.closest(".square");
        pieceDragged.hidden = false;

        if (elemBelow != lastHoverSquare) {
          if (lastHoverSquare) {
            lastHoverSquare.classList.remove("highlighted");
          }
          lastHoverSquare = elemBelow;
          if (lastHoverSquare && lastHoverSquare.classList.contains("can-move-to")) {
            lastHoverSquare.classList.add("highlighted");
          } else {
            lastHoverSquare = null;
          }
        }

      }

      // Mouse up handler
      function onMouseUpHandler(event) {
        console.log("Mouse up");
        document.removeEventListener('mousemove', onMouseMoveHandler);
        document.removeEventListener('mouseup', onMouseUpHandler);
        pieceDragged.classList.remove("dragging");
        if (!lastHoverSquare) {
          oldSquare.append(pieceDragged); //
        } else {
          if (lastHoverSquare.children.length != 0) {
            lastHoverSquare.children[0].remove();
            console.log("Removed!");
          }
          lastHoverSquare.append(pieceDragged);
        }

        oldSquare?.classList.remove("highlighted");
        lastHoverSquare?.classList.remove("highlighted");

        // unshowMoves(pieceDragged);
        // updateMoves();

        pieceDragged = null;
        oldSquare = null;
        lastHoverSquare = null;
      }

      function movePieceAtSpace(x, y) {
        const boardRect = chessBoard.getBoundingClientRect();
        pieceDragged.style.left = (x - boardRect.left - pieceDragged.offsetWidth / 2) + "px";
        pieceDragged.style.top = (y - boardRect.top - pieceDragged.offsetHeight / 2) + "px";
      }

    }




  </script>

</body>

</html>