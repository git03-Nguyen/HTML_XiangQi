<!DOCTYPE html>
<html>

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="./css/main.css">
  <title>Chinese Chess (Xiangqi) - 21120171</title>
</head>

<body>
  <!-- <h1>Nguyễn Đình Ánh - 21120171</h1> -->
  <!-- Chinese chess board -->
  <div class="game-container">
    <div class="chess-board">
      <img class="board-image" src="/img/board/board.png" alt="Board image">
      <div class="pieces-field">
        <div class="row">
          <div class="square">
            <img class="piece bRook" src="/img/pieces/bR.png" alt="black Rook">
          </div>
          <div class="square">
            <img class="piece" src="/img/pieces/bN.png" alt="black B">
          </div>
          <div class="square">
            <img class="piece" src="/img/pieces/bB.png" alt="black B">
          </div>
          <div class="square">
            <img class="piece" src="/img/pieces/bA.png" alt="black B">
          </div>
          <div class="square">
            <img class="piece" src="/img/pieces/bK.png" alt="black B">
          </div>
          <div class="square">
            <img class="piece" src="/img/pieces/bA.png" alt="black B">
          </div>
          <div class="square">
            <img class="piece" src="/img/pieces/bB.png" alt="black B">
          </div>
          <div class="square">
            <img class="piece" src="/img/pieces/bN.png" alt="black B">
          </div>
          <div class="square">
            <img class="piece" src="/img/pieces/bR.png" alt="black B">
          </div>
        </div>
        <div class="row">
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
        </div>
        <div class="row">
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
        </div>
        <div class="row">
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
        </div>
        <div class="row">
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
        </div>
        <div class="row">
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
        </div>
        <div class="row">
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
        </div>
        <div class="row">
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
        </div>
        <div class="row">
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
        </div>
        <div class="row">
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
          <div class="square"></div>
        </div>
      </div>
    </div>
  </div>

  <script>

    let chessBoard = document.querySelector(".chess-board");
    let allSquares = Array.from(document.querySelectorAll(".square"));

    let pieceDragged = null; // no piece is being dragged
    let oldSquare = null;
    let lastHoverSquare = null;

    function movePieceAtSpace(x, y) {
      const boardRect = chessBoard.getBoundingClientRect();
      pieceDragged.style.left = (x - boardRect.left - pieceDragged.offsetWidth / 2) + "px";
      pieceDragged.style.top = (y - boardRect.top - pieceDragged.offsetHeight / 2) + "px";
    }

    function movePieceAtSquare(x, y) {
      const newPosition = x + y * 9;
      const valid = (newPosition < 0 || newPosition > allSquares.length);
      if (!valid) {
        allSquares[oldSquare].append(pieceDragged);
      } else {
        allSquares[newPosition].children[0]?.remove();
        allSquares[newPosition].append(pieceDragged);
      }
    }

    function onMouseDownHandler(event) {
      if (!event.target.classList.contains("piece")) return;
      pieceDragged = event.target;
      oldSquare = pieceDragged.parentElement;
      console.log("Mouse down");

      chessBoard.insertAdjacentElement("afterBegin", pieceDragged);
      pieceDragged.classList.add("dragging");
      oldSquare.classList.add("highlighted");

      movePieceAtSpace(event.clientX, event.clientY);

      document.addEventListener('mousemove', onMouseMoveHandler);
      document.addEventListener('mouseup', onMouseUpHandler);
    }

    function onMouseMoveHandler(event) {

      console.log("Mouse move");
      movePieceAtSpace(event.clientX, event.clientY);

      oldSquare.classList.add("highlighted");

      pieceDragged.hidden = true;
      let elemBelow = document.elementFromPoint(event.clientX, event.clientY)?.closest(".square");
      pieceDragged.hidden = false;

      if (elemBelow != lastHoverSquare) {
        if (lastHoverSquare) {
          leaveHighlight();
        }
        lastHoverSquare = elemBelow;

        if (lastHoverSquare) {
          enterHighlight();
        }
      }






      // newX = Math.floor(newX / 67.0125);
      // newY = Math.floor(newY / 65.6);
      // console.log(`X:${newX} - Y:${newY} - ${event.target.className} - ${onDrag.className}`);
      // boardCoord[newX + (newY * 9)].insertAdjacentElement("beforeend", temp);
      // let destination = allSquares[newX + newY * 9];
      // if (destination.contains(pieceDragged)) return;
      // destination.classList.toggle("highlighted");



    }

    function leaveHighlight() {
      lastHoverSquare.classList.remove("highlighted");
    }

    function enterHighlight() {
      lastHoverSquare.classList.add("highlighted");
    }

    function onMouseUpHandler(event) {
      console.log("Mouse up");
      document.removeEventListener('mousemove', onMouseMoveHandler);
      document.removeEventListener('mouseup', onMouseUpHandler);
      pieceDragged.classList.remove("dragging");
      if (!lastHoverSquare) {
        oldSquare.append(pieceDragged); //
      } else {
        if (lastHoverSquare.children.length != 0) {
          lastHoverSquare.children[0].remove();
          console.log("Removed!");
        }
        lastHoverSquare.append(pieceDragged);
      }

      oldSquare?.classList.remove("highlighted");
      lastHoverSquare?.classList.remove("highlighted");

      pieceDragged = null;
      oldSquare = null;
      lastHoverSquare = null;
    }

    document.querySelectorAll(".piece").forEach(piece => {
      piece.addEventListener("mousedown", onMouseDownHandler);
      piece.ondragstart = (event) => event.preventDefault();
    });




  </script>

</body>

</html>